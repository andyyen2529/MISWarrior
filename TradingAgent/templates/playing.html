{% extends 'base.html' %}
{% load static %}
{% load staticfiles %}

{% block styles %}
<style>
#trend {
  float:left;
  width:60%;
}
#status {
  float:right;
  width:40%;
  background:#FFC;
  border-radius:25px;
  font-size: 20px;
}
#tbl {
  float:left;
  width:60%;
}
#historyField {
  float:left;
  width:60%;
}
#decision {
  float:right;
  width:30%;
}
#btn_waitOrHold, #btn_buyOrSell {
  background:#FC6;
  color:#966;
  width:100px;
  height:50px;
  font-size:20px;
  border-radius:12px;
  box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
    text-align: center;
  margin-right:25px;
  margin-left:25px;
  margin-bottom: 10px;
  font-weight: bold;
}
#setBtn {
  background:#3CF;
  color:#006;
  width:100px;
  height:50px;
  font-size:20px;
  border-radius:12px;
  box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
    text-align: center;
  margin-right:25px;
  margin-left:25px;
  margin-bottom: 10px;
  font-weight: bold;
}
th {
  font-family: '微軟正黑體';
  background-color: #417690;
  color:#fff;
  font-size: 18px;
}
td {
  background-color: #fff;
  font-family: Times New Roman;
  font-size: 18px;
}
</style>
{% endblock styles %}


{% block content %}
{% if user.is_authenticated %}

  <!--繪製股價走勢圖-->
  <div id="trend" style="width: 50%; height: 400px; "></div>
  {% block js %}
  <!--引入 JQuery 與 Highchart 的程式庫-->
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script src="http://code.highcharts.com/highcharts.js"></script>
  
  <script src="https://code.highcharts.com.cn/highcharts/highcharts.js"></script>
  <script src="https://code.highcharts.com.cn/highcharts/modules/exporting.js"></script>
  <script src="https://code.highcharts.com.cn/highcharts/modules/oldie.js"></script>
  <script src="https://code.highcharts.com.cn/highcharts-plugins/highcharts-zh_CN.js"></script>
  
  <script type= "text/javascript">
  
  $(document).ready(function() {
    var title = {
      text: '股價趨勢'
    };
    var subtitle = {
      text: 'Source: 臺灣證券交易所'
    };
    
    var xAxis = {
      title: {
        text: '過去30天股價'
      },
    };
    
    var yAxis = {
      title: {
        text: 'Closing Price (NTD)'
      },
      plotLines: [{
        value: 0,
        width: 1,
        color: '#808080'
      }]
    };

    var tooltip = {
      valueSuffix: ' NTD'
    }

    var legend = {
      layout: 'vertical',
      align: 'right',
      verticalAlign: 'middle',
      borderWidth: 0
    };

    var series =  [
    {
      name: '{{stock.code}}',
      data: {{price}}
    },
    
    ];

    var json = {};

    json.title = title;
    json.subtitle = subtitle;
    json.xAxis = xAxis;
    json.yAxis = yAxis;
    json.tooltip = tooltip;
    json.legend = legend;
    json.series = series;

    $('#trend').highcharts(json);
  })
  
  </script>
  {% endblock %}


  <div id = 'status'>
      <p style="margin-left:25px">現在是第 <a id="day">1</a> 天 
        (第 <a id="playingDuration">{{setup.playing_duration}}</a> 天結束)</p>
      <p style="margin-left:25px">您目前持有的資產：<a id="asset">現金{{ setup.principal }}元</a></p>
      <p style="margin-left:25px">您最後一次的交易價格(收盤價)： <a id="lastTradingPrice">暫無</a></p> 
      <p style="margin-left:25px">您截至目前的報酬率： <a id="return">0.000%</a></p>
    <p>&nbsp;</p>

    <form id="actionForm" type='post'>
      {% csrf_token %}

      <input type="button" id="btn_waitOrHold" value="等待">
      <input type="button" id="btn_buyOrSell" value="買入">


      <input id="stockIdField" type="hidden" name="id" value="{{ stock.id }}">
      <input id="historyIdField" type="hidden" name="historyId" value="{{ history.id }}">
      <input id="closingPriceField" type="hidden" name="closingPrice" value="{{ stock.closing_price }}">
    </form>

    <form type="post">
      {% csrf_token %}
      <input type="button" id='btn_history' value="歷史紀錄" name='getHistory'>
    </form>

    <form id="infoForm" method="post" action="">
        <input type="button" id='setBtn' value="重新開始" onclick="location.href='http://127.0.0.1:8000/stockGame/setup'">
    </form> 

  </div>
  <p>&nbsp;</p>

  <div id = 'tbl'>
    <table width=100% border="1" style="table-layout:fixed">

    　<tr>
      　<th>股票代碼</td>
      　<th>日期</td>
      　<th>成交股數</td>
      　<th>成交金額</td>
      </tr>
    　<tr>
      　<td id="code">{{stock.code}}</td>
      　<td id="date">{{stock.date |date:"Y-m-d"}} </td>
      　<td id="volumn">{{stock.volumn}} </td>
      　<td id="turnover">{{stock.turnover}} </td>
      </tr>

    　<tr>
      　<th>開盤價</td>
      　<th>最高價</td>
      　<th>最低價</td>
      　<th>收盤價</td>
      </tr>
      <tr>
      　<td id="opening_price">{{stock.opening_price}} </td>
      　<td id="high">{{stock.high}} </td>
      　<td id="low">{{stock.low}} </td>
      　<td id="closing_price">{{stock.closing_price}} </td>
    　</tr>

    </table>
  </div>

  <div id = 'decision'>

    <script>
      // 獲取歷史紀錄
      $('#btn_history').click(function(){
        $.ajax({
          url : "/ajax/history/", // the endpoint
          type : "POST", // http method
          data: {csrfmiddlewaretoken: "{{ csrf_token }}"}, 

          // handle a successful response
          success : function(json) {
            console.log("success"); // another sanity check
            var myJSON = JSON.stringify(json);
            $("#historyField").text(myJSON);

          },
          error: function() {
            $('.testing').text('失敗');
          },
        });
      });

      // 獲取股票資料
      $('#actionForm').click(function(){
        $.ajax({
          url : "/ajax/stockDay/", // the endpoint
          type : "POST", // http method
          data : $('#actionForm').serialize(), // data sent with the post request

          // handle a successful response
          success : function(json) {
            console.log("success"); // another sanity check

            if ((parseInt($("#day").text())) >= (parseInt($("#playingDuration").text()))) {
              return;
            }

            $("#code").text(json[0].fields.code);
            $("#date").text(json[0].fields.date);
            $("#volumn").text(json[0].fields.volumn);                    
            $("#turnover").text(json[0].fields.turnover);

            $("#opening_price").text(json[0].fields.opening_price);
            $("#high").text(json[0].fields.high);
            $("#low").text(json[0].fields.low);                    
            $("#closing_price").text(json[0].fields.closing_price);

            $("#closingPriceField").val(json[0].fields.closing_price);

            $('#stockIdField').val(json[0].pk);
          },
          error: function() {
            $('.testing').text('失敗');
          },
        });
      });
                 

      // 按下「等待or持有」按鈕之後的後端數據處理
      $("#btn_waitOrHold").click(function(){
        $.ajax({
          url : "/ajax/addingHistory_waitOrHold/", // the endpoint
          type : "POST", // http method
          data : $('#actionForm').serialize(),

          // handle a successful response
          success : function(json) {
            console.log("success"); // another sanity check

            if ((json[0].fields.day + 1) > parseInt($("#playingDuration").text())) {
              alert('本次投資模擬結束，之後將結算成績！')
              document.location.href = "http://127.0.0.1:8000/";
              return;
            }

            $("#historyIdField").val(json[0].pk);
            $("#day").text(json[0].fields.day + 1);
            $("#position").text(json[0].fields.position_after_action);
            $("#return").text((json[0].fields.rate_of_return_after_action * 100).toFixed(3).toString().concat('%'));

            if (json[0].fields.last_trading_price_after_action == null){
              $("#lastTradingPrice").text('暫無');
            } else {
              $("#lastTradingPrice").text(json[0].fields.last_trading_price_after_action);
            }
            
            $("#cash").text(json[0].fields.cash_held_after_action);
            $("#stockNum").text(json[0].fields.number_of_shares_held_after_action);

            if ((json[0].fields.day + 1) > parseInt($("#playingDuration").text())) {
              alert('本次投資模擬結束，之後將結算成績！')
            }

            if (json[0].fields.position_after_action == '現金') {
              document.getElementById("btn_waitOrHold").value = '等待'
              document.getElementById("btn_buyOrSell").value = '買入'
              $("#asset").text('現金' + json[0].fields.cash_held_after_action.toFixed(4) + '元');
            } else { 
              document.getElementById("btn_waitOrHold").value = '持有'
              document.getElementById("btn_buyOrSell").value = '賣出'
              $("#asset").text('股票' + json[0].fields.number_of_shares_held_after_action.toFixed(4) + '股');
            }

          },
            error: function() {
            $('.testing').text('失敗');
          },
        });
      });

      // 按下「買入or賣出」按鈕之後的後端數據處理
      $("#btn_buyOrSell").click(function(){
        $.ajax({
          url : "/ajax/addingHistory_buyOrSell/", // the endpoint
          type : "POST", // http method
          data : $('#actionForm').serialize(),

          // handle a successful response
          success : function(json) {
            console.log("success"); // another sanity check            

            if ((json[0].fields.day + 1) > parseInt($("#playingDuration").text())) {
              alert('本次投資模擬結束，之後將結算成績！')
              document.location.href = "http://127.0.0.1:8000/";
              return;
            }

            $("#historyIdField").val(json[0].pk);
            $("#day").text(json[0].fields.day + 1);
            $("#position").text(json[0].fields.position_after_action);
            $("#return").text((json[0].fields.rate_of_return_after_action * 100).toFixed(3).toString().concat('%'));

            if (json[0].fields.last_trading_price_after_action == null){
              $("#lastTradingPrice").text('暫無');
            } else {
              $("#lastTradingPrice").text(json[0].fields.last_trading_price_after_action);
            }

            $("#cash").text(json[0].fields.cash_held_after_action);
            $("#stockNum").text(json[0].fields.number_of_shares_held_after_action);

            if (json[0].fields.position_after_action == '現金') {
              document.getElementById("btn_waitOrHold").value = '等待'
              document.getElementById("btn_buyOrSell").value = '買入'
              $("#asset").text('現金' + json[0].fields.cash_held_after_action.toFixed(4) + '元');
            } else { 
              document.getElementById("btn_waitOrHold").value = '持有'
              document.getElementById("btn_buyOrSell").value = '賣出'
              $("#asset").text('股票' + json[0].fields.number_of_shares_held_after_action.toFixed(4) + '股');
            }

          },
            error: function() {
            $('.testing').text('失敗');
          },
        });
      });

    </script>
  </div>

  <div>
    <a id="historyField"></a>
  </div>

{% else %}
<div id = 'signUpNotificationDiv'>
  <p>想要使用「個股投資模擬」的功能嗎？</p>
  <p>那就立刻加入股獲仔吧！</p>
  <input type="button" id="input-style1" onclick="location.href='http://127.0.0.1:8000/accounts/login/';" value="立即使用" />
</div>

{% endif %}
{% endblock %}